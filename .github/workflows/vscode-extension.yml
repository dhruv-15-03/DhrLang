name: VS Code Extension Release

on:
  push:
    tags: ['vscode-v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Extension version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-extension:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json
          
      - name: Install dependencies
        working-directory: vscode-extension
        run: npm install
        
      - name: Install vsce
        run: npm install -g @vscode/vsce
        
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/vscode-v}
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
          
      - name: Update package version
        working-directory: vscode-extension
        run: |
          npm version ${{ steps.get_version.outputs.VERSION }} --no-git-tag-version
          
      - name: Compile TypeScript
        working-directory: vscode-extension
        run: npm run compile
        
      - name: Create extension icon
        working-directory: vscode-extension
        run: |
          mkdir -p images
          # Create a simple SVG icon for now
          cat > images/icon.png << 'EOF'
          <!-- This would be a proper PNG icon -->
          EOF
          
          # Create simple file icons
          cat > images/file-icon-light.svg << 'EOF'
          <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <rect width="16" height="16" fill="#FF6B35" rx="2"/>
            <text x="8" y="12" font-family="Arial, sans-serif" font-size="10" fill="white" text-anchor="middle">‡§ß</text>
          </svg>
          EOF
          
          cat > images/file-icon-dark.svg << 'EOF'
          <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <rect width="16" height="16" fill="#FF6B35" rx="2"/>
            <text x="8" y="12" font-family="Arial, sans-serif" font-size="10" fill="white" text-anchor="middle">‡§ß</text>
          </svg>
          EOF
          
          # Convert SVG to PNG for icon (placeholder - would need proper icon)
          echo "Creating placeholder icon..."
          # In real scenario, you'd have a proper icon file
          touch images/icon.png
          
      - name: Package extension
        working-directory: vscode-extension
        run: vsce package --no-yarn
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: vscode-v${{ steps.get_version.outputs.VERSION }}
          name: DhrLang VS Code Extension v${{ steps.get_version.outputs.VERSION }}
          body: |
            # DhrLang VS Code Extension v${{ steps.get_version.outputs.VERSION }}
            
            ## Features (English-core token set)
            - üé® Updated grammar for `num`, `duo`, `sab`, `kya`, `ek`, `kaam`
            - üß† Snippets: main class, methods, loops, conditionals, printLine
            - üöÄ Run & compile commands (Ctrl+F5 / Ctrl+Shift+B)
            - ÔøΩ Hover + basic diagnostics surfacing compiler output
            - ‚öôÔ∏è Auto JAR detection & configurable settings
            
            ## Installation
            1. Download the `.vsix` from this release OR install from Marketplace (when published)
            2. VS Code Command Palette: "Extensions: Install from VSIX..."
            3. Select the downloaded file
            4. Open a `.dhr` file to activate
            
            ## Requirements
            - VS Code 1.74.0+
            - Java 17+
            - `DhrLang.jar` accessible (auto-detected or configure setting)
            
            ## Quick Start
            ```dhrlang
            class Main {
                static kaam main() { printLine("Hello, DhrLang!"); }
            }
            ```
            Press Ctrl+F5 to run.
            
            ## Notes
            Legacy Hindi keyword forms are no longer part of the advertised grammar; docs now reflect current language direction.
          draft: false
          prerelease: false
          files: |
            vscode-extension/*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # Uncomment when ready to publish to marketplace
      # - name: Publish to VS Code Marketplace
      #   working-directory: vscode-extension
      #   run: vsce publish --no-yarn
      #   env:
      #     VSCE_PAT: ${{ secrets.VSCE_PAT }}
      
      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: dhrlang-vscode-extension
          path: vscode-extension/*.vsix