name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  checks: write   # Needed for dorny/test-reporter to create check run

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        
      - name: Make gradlew executable
        run: chmod +x ./gradlew
        
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW="${{ github.event.inputs.version }}"
          else
            RAW="${GITHUB_REF#refs/tags/}"
          fi
          CLEAN=${RAW#v}
          echo "RAW_TAG=$RAW" >> $GITHUB_OUTPUT
            echo "VERSION=$CLEAN" >> $GITHUB_OUTPUT
          
      - name: Build JAR
        run: ./gradlew clean shadowJar distZip distTar
        
      - name: Run tests
        run: ./gradlew test
        
      - name: Generate test report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: DhrLang Tests
          path: build/test-results/test/*.xml
          reporter: java-junit
          fail-on-error: false
          
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          # Prefer shadow (fat) jar if present; fallback to any jar
          JAR=$(ls build/libs/*-all.jar 2>/dev/null | head -n1)
          if [ -z "$JAR" ]; then
            JAR=$(ls build/libs/*.jar | head -n1)
          fi
          if [ -z "$JAR" ]; then
            echo "No JAR found in build/libs" >&2
            exit 1
          fi
          cp "$JAR" release/DhrLang.jar
          cp README.md release/
          cp LICENSE release/
          cp GETTING_STARTED.md release/
          cp INSTALL.md release/
          cp TUTORIALS.md release/
          cp EXAMPLES.md release/

          # Create examples directory in release (using current input/ folder as canonical sample programs)
          mkdir -p release/examples
          cp input/* release/examples/ 2>/dev/null || true
          
          # Create release info
          echo "# DhrLang v${{ steps.get_version.outputs.VERSION }}" > release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "## Installation" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### Quick Start" >> release/RELEASE_NOTES.md
          echo '```bash' >> release/RELEASE_NOTES.md
          echo "# Download DhrLang.jar from this release" >> release/RELEASE_NOTES.md
          echo "java -jar DhrLang.jar your_program.dhr" >> release/RELEASE_NOTES.md
          echo '```' >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "### System Requirements" >> release/RELEASE_NOTES.md
          echo "- Java 17 or higher" >> release/RELEASE_NOTES.md
          echo "- Any operating system (Windows, macOS, Linux)" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "## What's New" >> release/RELEASE_NOTES.md
          echo "" >> release/RELEASE_NOTES.md
          echo "See the [changelog](CHANGELOG.md) for detailed release notes." >> release/RELEASE_NOTES.md
      - name: Package VS Code extension (vsix)
        run: |
          echo "Packaging VS Code extension..."
          
          # Copy the built JAR to the extension compiler directory
          mkdir -p vscode-extension/compiler
          cp release/DhrLang.jar vscode-extension/compiler/DhrLang.jar
          
          pushd vscode-extension
          npm ci --no-audit --no-fund
          npx vsce package --no-yarn || (npm install -g @vscode/vsce && vsce package --no-yarn)
          cp *.vsix ../release/ || true
          popd

      - name: List release directory (debug)
        run: ls -l release

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: dhrlang-jar
          path: release/DhrLang.jar
          retention-days: 2
          
      - name: Create release archives
        run: |
          cd release
          tar -czf ../DhrLang-${{ steps.get_version.outputs.VERSION }}-linux.tar.gz *
          zip -r ../DhrLang-${{ steps.get_version.outputs.VERSION }}-windows.zip *
          cd ..
          
      - name: Generate checksums
        run: |
          sha256sum DhrLang-*.tar.gz DhrLang-*.zip release/DhrLang.jar > checksums.txt
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: DhrLang v${{ steps.get_version.outputs.VERSION }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release/DhrLang.jar
            DhrLang-${{ steps.get_version.outputs.VERSION }}-linux.tar.gz
            DhrLang-${{ steps.get_version.outputs.VERSION }}-windows.zip
            checksums.txt
            release/*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Publish to GitHub Packages
        run: ./gradlew -Pversion=${{ steps.get_version.outputs.VERSION }} publish --info --stacktrace
        env:
          GPR_USER: ${{ github.actor }}
          GPR_KEY: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  create-homebrew-formula:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Setup variables
        id: vars
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: dhrlang-jar
          path: .

      - name: Compute checksum
        run: |
          test -f DhrLang.jar || { echo 'DhrLang.jar missing'; ls -al; exit 1; }
          SHA256=$(sha256sum DhrLang.jar | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          
      - name: Create Homebrew formula PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            const formula = `class Dhrlang < Formula
              desc "DhrLang programming language (English-core tokens: num/duo/sab/kya/ek/kaam)"
              homepage "https://github.com/${{ github.repository }}"
              url "https://github.com/${{ github.repository }}/releases/download/v${{ steps.vars.outputs.VERSION }}/DhrLang.jar"
              sha256 "${{ env.SHA256 }}"
              license "MIT"
              version "${{ steps.vars.outputs.VERSION }}"

              depends_on "openjdk@17"

              def install
                libexec.install "DhrLang.jar"
                (bin/"dhrlang").write <<~EOS
                  #!/bin/bash
                  exec "#{Formula["openjdk@17"].opt_bin}/java" -jar "#{libexec}/DhrLang.jar" "$@"
                EOS
              end

              test do
                (testpath/"test.dhr").write <<~EOS
                  class Main {
                    static kaam main() {
                      printLine("Hello DhrLang!");
                    }
                  }
                EOS
                assert_match "Hello DhrLang!", shell_output("#{bin}/dhrlang #{testpath}/test.dhr")
              end
            end`;
            
            console.log('Homebrew formula would be:');
            console.log(formula);
            
            // In a real scenario, you would create a PR to homebrew-core or your own tap
            // For now, we just log the formula that would be created
            
  notify-release:
    needs: [build-and-release, create-homebrew-formula]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Notify success
        if: needs.build-and-release.result == 'success'
        run: |
          echo "üéâ DhrLang ${{ steps.get_version.outputs.VERSION }} released successfully!"
          echo "üì¶ Assets available at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}"
          echo "üöÄ Ready for distribution!"
          
      - name: Notify failure
        if: needs.build-and-release.result == 'failure'
        run: |
          echo "‚ùå Release failed for DhrLang ${{ steps.get_version.outputs.VERSION }}"
          echo "Check the logs for details"
          # Do not force exit 1; overall workflow already marked failed